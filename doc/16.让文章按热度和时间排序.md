# 让文章按热度和事件排序
![](https://img-blog.csdnimg.cn/img_convert/c270854092f5a02029b9bd67da5184b8.png)

浏览量或者说文章热度是评估一篇博文质量的重要指数。一般的博客网站都具备统计以及按照浏览量排序的功能。

本文我们来实现博文浏览的统计，同时增加按照热度和时间排序的功能。

# 统计文章浏览量

## 修改模型
要实现浏览量功能，我们首先需要增加一个浏览量字段。

因此修改文章的模型：

```python
# 博客文章数据模型
class Article(models.Model):
    # 文章id,主键
    id = models.AutoField(primary_key=True)
 
    # 文章作者。修改为User的外键，参数 on_delete 用于指定数据删除的方式
    author = models.ForeignKey(User, on_delete=models.CASCADE)
 
    # 文章标题,models.CharField 为字符串字段，用于保存较短的字符串，比如标题
    title = models.CharField('标题',max_length=100)
 
    # 文章正文,保存大量文本使用 TextField
    body = models.TextField('文章正文')
 
    # 文章创建时间,参数 default=timezone.now 指定其在创建数据时将默认写入当前的时间
    created = models.DateTimeField(default=timezone.now)
    # 增加浏览量字段
    total_views = models.PositiveIntegerField(default=0)
 
    # 文章更新时间,参数 auto_now=True 指定每次数据更新时自动写入当前时间
    updated = models.DateTimeField(auto_now=True)
    # 获取文章地址
    def get_absolute_url(self):
        return reverse('detail', args=[self.id])
```

- PositiveIntegerField是用于存储正整数的字段
- default=0设定初始值从0开始
  
迁移下数据

`python manage.py makemigrations`

`python manage.py migrate`

## 修改视图

### 创建评论管理模块app
```sh
python manage.py startapp comment
```
### 注册APP
```python
INSTALLED_APPS = [
    ...
    'comment',     # 添加此项
]
```
### 定义模型
```python
from django.db import models
# 导入内建的User模型
from django.contrib.auth.models import User

from application.models import Article

# 博文的评论
class Comment(models.Model):
    article = models.ForeignKey(Article,on_delete=models.CASCADE,related_name='comments')
    user = models.ForeignKey(User,on_delete=models.CASCADE,related_name='comments')
    body = models.TextField()
    created = models.DateTimeField(auto_now_add=True)
```

### 修改article_detail()
我们需要实现的是每当用户访问详情页面时，浏览量就加1。

因此修改article_detail()如下：

```python
# 文章详情
def article_detail(request,id):
    # 取出相应的文章
    article = Article.objects.get(id=id)
    # 浏览量 +1
    article.total_views += 1
    article.save(update_fields=['total_views'])
    # 取出文章评论
    comments = Comment.objects.filter(article=id)
    # 需要传递给模板的对象
    context = {'article': article, 'comments': comments}
    # 载入模板，并返回context对象
    return render(request, 'article/detail.html', context)
```

update_fields=[]指定了数据库只更新total_views字段，优化执行效率。

## 修改列表模板
首先我们在列表的每个文章卡片上都加上一个阅读量的显示。

这里我们为了美观，我们加上一个阅读量的图标。

使用图标我们需要引入图标库，这里我们通过在线形式引入。

在templates/base.html中增加如下代码：
```html
<!--    载入静态文件-->
{% load static %}
 
<!DOCTYPE html>
<!-- 网站主语言 -->
<html lang="zh-cn">
  <head>
    ...
    <!-- 引入图标库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  </head>
```

然后在templates/article/list.html 中增加代码如下：
```html
      	...
						<div class="card-body">
                    ...
                    <!-- 这里增加阅读量和图标 -->
                        <small class="col align-self-end" style="color: gray;">
                            <span class="bi bi-eye">
                            {{ article.total_views }}
                            </span>
                        </small>
                </div>
```

实现效果如下：

![](https://img-blog.csdnimg.cn/d91aa869db3a4f0ab4f121488c227457.png)

# 改详情模板
类似的，我们在详情页面标题后面也增加图标和阅读量。
```html
<div class="col-12 alert alert-primary">
            <div class="col-12">
                ...
               <!-- 增加阅读量和图标 -->
                <small class="col align-self-end" style="color: gray;">
                            <span class="bi bi-eye">
                            {{ article.total_views }}
                            </span>
                </small>
            </div>
        </div>
```